<!DOCTYPE html>
<html>
<head>
  <title>📦 Trade Players & Draft Picks</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { background: #e8f5e9; }
    h1 { color: #2e7d32; text-align: center; }
    textarea, select, button { width: 95%; margin: 8px auto; padding: 10px; display: block; }
    label { text-align: center; display: block; margin: 10px auto; }
    pre { white-space: pre-wrap; background: #f1f8e9; padding: 10px; }
  </style>
</head>
<body>
<h1>📦 Trade With Draft Picks</h1>

<h3>Your Package (Players, Picks)</h3>
<textarea id="myPackage" placeholder="Example: John Doe,2026 1st,2028 2nd"></textarea>

<h3>Opponent Team & Package (Format: TeamName:Player1,2027 1st,...)</h3>
<textarea id="theirPackage" placeholder="Example: Lakers:Steve Smith,2029 2nd"></textarea>

<label><input type="checkbox" id="forceTrade"> Force Trade (Ignore AI/cap rules)</label>

<button onclick="comparePackages()">Compare</button>
<pre id="result"></pre>
<button onclick="proposeTrade()">Execute Trade</button>

<div class="navbar">
  <a href="index.html">🏠 Home</a>
  <a href="roster.html">📋 Roster</a>
  <a href="depth.html">📊 Depth</a>
  <a href="save.html">💾 Save</a>
  <a href="fullseason.html">▶️ Sim</a>
</div>

<script>
const gameState = JSON.parse(localStorage.getItem("basketballGM")) || {};
const result = document.getElementById("result");

function parseAsset(name, roster, picks) {
  if (/\d{4}\s(1st|2nd)/.test(name)) return picks.find(p => p.name === name);
  return roster.find(p => p.name === name);
}

function getTotalValue(assets) {
  return assets.reduce((sum, a) => sum + ((a.rating || 0) + (a.value || 0)), 0);
}

function getContractTotal(players) {
  return players.reduce((sum, p) => sum + (p.contract || 0), 0);
}

function buildPick(name) {
  const round = name.includes("1st") ? 1 : 2;
  return { name, round, value: round === 1 ? 8 : 4, contract: 0 };
}

function getAssets(input, roster, picks) {
  const names = input.split(",").map(n => n.trim()).filter(Boolean);
  return names.map(n => parseAsset(n, roster, picks) || buildPick(n));
}

function getTeamCap(teamName) {
  return gameState.teams?.[teamName]?.cap || 120;
}
function setTeamCap(teamName, cap) {
  if (!gameState.teams[teamName]) return;
  gameState.teams[teamName].cap = cap;
}
function getMyCap() {
  return gameState.myCap || 120;
}
function setMyCap(cap) {
  gameState.myCap = cap;
}

function comparePackages() {
  const myText = document.getElementById("myPackage").value.trim();
  const theirInput = document.getElementById("theirPackage").value.trim();
  const [teamName, ...teamAssets] = theirInput.split(":");
  const theirText = teamAssets.join(":");

  const myPlayers = gameState.roster || [];
  const theirRoster = gameState.teams?.[teamName]?.roster || [];
  const myPicks = gameState.draftPicks || [];
  const theirPicks = gameState.teams?.[teamName]?.draftPicks || [];

  const myAssets = getAssets(myText, myPlayers, myPicks);
  const theirAssets = getAssets(theirText, theirRoster, theirPicks);

  const myVal = getTotalValue(myAssets);
  const theirVal = getTotalValue(theirAssets);

  const aiApproval = theirVal >= myVal * 0.95;

  result.textContent = `📦 Trade Summary:
You send: ${myAssets.map(a => a.name).join(", ")}
They send: ${theirAssets.map(a => a.name).join(", ")}
Total Value: You ${myVal} vs Them ${theirVal}
AI Decision: ${aiApproval ? "✅ Approved" : "❌ Rejected"}
`;
}

function proposeTrade() {
  const myText = document.getElementById("myPackage").value.trim();
  const theirInput = document.getElementById("theirPackage").value.trim();
  const [teamName, ...teamAssets] = theirInput.split(":");
  const theirText = teamAssets.join(":");
  const override = document.getElementById("forceTrade").checked;

  const myPlayers = gameState.roster || [];
  const theirRoster = gameState.teams?.[teamName]?.roster || [];
  const myPicks = gameState.draftPicks || [];
  const theirPicks = gameState.teams?.[teamName]?.draftPicks || [];

  const myAssets = getAssets(myText, myPlayers, myPicks);
  const theirAssets = getAssets(theirText, theirRoster, theirPicks);

  const myVal = getTotalValue(myAssets);
  const theirVal = getTotalValue(theirAssets);
  const aiApproval = theirVal >= myVal * 0.95;

  if (!override && !aiApproval) {
    result.textContent += "\n❌ Trade not executed (AI veto).";
    return;
  }

  const remove = (arr, name) => {
    const i = arr.findIndex(x => x.name === name);
    if (i !== -1) arr.splice(i, 1);
  };

  myAssets.forEach(a => remove(gameState.roster, a.name) || remove(gameState.draftPicks, a.name));
  theirAssets.forEach(a => remove(theirRoster, a.name) || remove(theirPicks, a.name));

  gameState.roster.push(...theirAssets.filter(a => a.rating || a.value));
  theirRoster.push(...myAssets.filter(a => a.rating || a.value));

  gameState.draftPicks.push(...theirAssets.filter(a => a.round));
  theirPicks.push(...myAssets.filter(a => a.round));

  gameState.teams[teamName].roster = theirRoster;
  gameState.teams[teamName].draftPicks = theirPicks;
  localStorage.setItem("basketballGM", JSON.stringify(gameState));
  result.textContent += "\n✅ Trade completed.";
}
</script>
</body>
</html>
